
# Backend Service

## Database selection

The backend now uses **SQLite** as the primary data store. SQLite keeps the entire database inside a single file (`dev.db` by default) which eliminates the need to provision and manage an external PostgreSQL server. This simplifies local development, CI pipelines, and demo environments while keeping the Prisma data model unchanged. If you previously relied on PostgreSQL-specific features (such as extensions or triggers) they have been removed or replaced with Prisma-managed alternatives to maintain compatibility with SQLite.

## Getting started

1. Copy the environment template and adjust it to your local setup:

   ```bash
   cd backend
   cp .env.example .env
   ```

   Update the `DATABASE_URL` if you want to store the SQLite database in a custom location. The default value (`file:./dev.db`) stores the database in the `backend/` directory.

2. Install dependencies and generate the Prisma client:

   ```bash
   npm install
   npm run prisma:generate
   ```

3. Apply database migrations:

   ```bash
   # For local development (creates new migrations when the schema changes)
   npm run prisma:migrate:dev -- --name init

   # For CI/CD or production environments
   npm run prisma:migrate
   ```

   The first migration creates the SQLite database file and the `Customer` table. UUID identifiers are generated by Prisma so no database extensions are required.

4. Seed at least one customer record for testing. Configure the seed variables in `.env` (see `.env.example`) and run the helper script, or open Prisma Studio to manage records manually.

   ```bash
   # Seed a deterministic customer based on the values in your .env file
   npm run seed

   # Or inspect/edit records through a UI
   npx prisma studio
   ```

   The seed script expects the following environment variables in `.env`:

   - `SEED_CUSTOMER_EMAIL`
   - `SEED_CUSTOMER_PASSWORD`
   - `SEED_CUSTOMER_FIRST_NAME`
   - `SEED_CUSTOMER_LAST_NAME`

   Optional variables (`SEED_CUSTOMER_PHONE`, `SEED_CUSTOMER_DATE_OF_BIRTH`, and `SEED_CUSTOMER_IS_ACTIVE`) let you further customize the initial record. Running `npm run seed` multiple times keeps the record in sync by updating the existing customer when the email matches.

5. Start the development server:

   ```bash
   npm run dev
   ```

   The server listens on the port defined by the `PORT` environment variable (defaults to `3001`).

## Customer model

`prisma/schema.prisma` defines the `Customer` table with the following core fields:

| Field          | Type      | Notes                                               |
|----------------|-----------|-----------------------------------------------------|
| `id`           | UUID      | Primary key generated via `uuid()`                  |
| `email`        | String    | Unique login identifier                            |
| `passwordHash` | String    | BCrypt hash of the login password                  |
| `firstName`    | String    | Customer first name                                |
| `lastName`     | String    | Customer surname                                   |
| `phoneNumber`  | String?   | Optional contact number                            |
| `dateOfBirth`  | DateTime? | Optional date of birth metadata                    |
| `isActive`     | Boolean   | Indicates whether the customer can authenticate    |
| `lastLoginAt`  | DateTime? | Timestamp of the most recent successful login      |
| `createdAt`    | DateTime  | Creation timestamp (managed by the database)       |
| `updatedAt`    | DateTime  | Update timestamp (managed by Prisma/database)      |

## Login flow

The `/api/login` endpoint accepts an `email` and `password`, performs a lookup via Prisma against the SQLite database, verifies the password using bcrypt, updates the `lastLoginAt` timestamp, and returns only the non-sensitive customer profile fields (ID, email, names, phone, date of birth, and latest login timestamp). This ensures all authentication attempts leverage the centralized relational data model without exposing credential hashes or internal flags.

## Tests

Run `npm test` to execute integration tests that exercise the login and health check endpoints.

## Additional commands

- `npm run prisma:generate`: Regenerate the Prisma client after editing `schema.prisma`.
- `npm run prisma:migrate:dev`: Create and apply a new migration while developing locally.
- `npm run prisma:migrate`: Apply migrations without creating new ones (useful for CI/CD).
- `npm run seed`: Populate or refresh a development customer using the values provided in `.env`.

## Project structure

```
backend/
├── .env.example
├── package.json
├── prisma/
│   ├── migrations/
│   │   ├── 0001_init/
│   │   │   └── migration.sql
│   │   └── migration_lock.toml
│   └── schema.prisma
└── src/
    ├── lib/
    │   └── prisma.js
    ├── services/
    │   └── customerService.js
    └── server.js
```